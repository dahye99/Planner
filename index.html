<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ïà†ÏùÑ Î®πÏûê ÎÉ†ÎÉêÎØ∏</title>

  <!-- Ï∫êÏãú Î¨¥Ìö®Ìôî(Î™®Î∞îÏùº ÏµúÏã† Î∞òÏòÅ Î≥¥Ïû•) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="icon" href="data:,">

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f5f5f5}
    .container{display:flex;height:100vh;flex-direction:column}
    .day-selector{display:flex;gap:20px;padding:20px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.1);justify-content:center}
    .day-btn{padding:12px 30px;border:2px solid #ddd;border-radius:25px;background:#fff;cursor:pointer;font-size:16px;font-weight:600;transition:.3s}
    .day-btn.active{background:#2196F3;color:#fff;border-color:#2196F3}
    .day-btn:hover{border-color:#2196F3}
    .content{display:flex;flex:1;gap:20px;padding:20px;overflow:hidden}
    .map-container{flex:1;border-radius:12px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.1);position:relative}
    #map{width:100%;height:100%}
    .map-marker-label{background:#fff;padding:8px 12px;border-radius:20px;border:2px solid #2196F3;font-weight:bold;font-size:14px;color:#2196F3;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.15);transition:.2s}
    .map-marker-label:hover{background:#2196F3;color:#fff;transform:scale(1.1)}
    .sidebar{width:350px;display:flex;flex-direction:column;gap:20px;overflow-y:auto}
    .list-section{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.1);flex:1;overflow-y:auto}
    .list-section h2{font-size:18px;margin-bottom:15px;color:#333;border-bottom:2px solid #f0f0f0;padding-bottom:10px}
    .place-item{display:flex;flex-direction:column;gap:8px;padding:12px;margin-bottom:10px;background:#f9f9f9;border-radius:8px;cursor:pointer;transition:.3s;border-left:4px solid #e0e0e0}
    .place-item:hover{background:#e3f2fd;border-left-color:#2196F3;transform:translateX(5px)}
    .place-header{display:flex;align-items:center;gap:12px}
    .place-number{display:flex;align-items:center;justify-content:center;width:32px;height:32px;background:#2196F3;color:#fff;border-radius:50%;font-weight:bold;font-size:14px;flex-shrink:0}
    .place-info{flex:1;min-width:0}
    .place-name{font-weight:600;color:#333;margin-bottom:4px;word-break:break-word}
    .place-category{font-size:12px;color:#999}
    .place-meta{margin-top:4px}
    .place-addr small{color:#666}
    .place-time small{color:#555}
    .place-item.active{background:#fff3e0;border-left-color:#ff9800}
    .btn{padding:8px 12px;border:none;border-radius:6px;color:#fff;font-size:12px;font-weight:600;cursor:pointer;transition:.2s}
    .btn:hover{transform:scale(1.05)}
    .btn.info{background:#4CAF50}.btn.info:hover{background:#45a049}
    .btn.walk{background:#1976d2}.btn.walk:hover{background:#1565c0}
    .btn.secondary{background:#9c27b0}.btn.secondary:hover{background:#7b1fa2}
    .btn:disabled{background:#ccc;cursor:not-allowed;transform:none}
    .todo-item{display:flex;align-items:flex-start;gap:10px;padding:12px;margin-bottom:8px;background:#f9f9f9;border-radius:8px;border-left:4px solid #4CAF50;word-break:break-word}
    .todo-number{font-weight:bold;color:#4CAF50;flex-shrink:0;min-width:20px}
    .todo-text{color:#333;font-size:14px}
    .sidebar::-webkit-scrollbar,.list-section::-webkit-scrollbar{width:6px}
    .sidebar::-webkit-scrollbar-track,.list-section::-webkit-scrollbar-track{background:#f1f1f1;border-radius:10px}
    .sidebar::-webkit-scrollbar-thumb,.list-section::-webkit-scrollbar-thumb{background:#888;border-radius:10px}
    .sidebar::-webkit-scrollbar-thumb:hover,.list-section::-webkit-scrollbar-thumb:hover{background:#555}

    /* Î™®Î∞îÏùº: Î¶¨Ïä§Ìä∏ Î∞ïÏä§ Í∞ÅÍ∞Å 2.5Î∞∞(‚âà50vh)Î°ú ÌÇ§Ïö∞Í∏∞ */
    @media (max-width:1024px){
      .content{flex-direction:column; overflow:auto;}
      .sidebar{width:100%; height:auto;}
      .map-container{height:60vh;}
      .list-section{min-height:50vh;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="day-selector">
      <button class="day-btn active" data-day="day1">Day 1</button>
      <button class="day-btn" data-day="day2">Day 2</button>
    </div>

    <div class="content">
      <div class="map-container"><div id="map"></div></div>
      <div class="sidebar">
        <div class="list-section">
          <h2>üóíÔ∏è Place List</h2>
          <div id="placeList"></div>
        </div>
        <div class="list-section">
          <h2>üóíÔ∏è To-do List</h2>
          <div id="todoList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== Ï∫êÏãúÎ≤ÑÏä§ÌÑ∞(Î™®Î∞îÏùº Í∞ïÏ†ú ÏµúÏã†Ìôî) ===== */
    const APP_VERSION = '20251021_05';
    (function enforceVersion(){
      // ÌååÏùºÎ°ú Ïó¥ÏóàÏúºÎ©¥ Í∞ïÏ†ú Î¶¨Îã§Ïù¥Î†âÌä∏ ÌïòÏßÄ ÏïäÏùå (Î™®Î∞îÏùº ÌååÏùºÎ∑∞ ÏòàÏô∏)
      if (location.protocol === 'file:') return;
      const url = new URL(location.href);
      const v = url.searchParams.get('v');
      if (v !== APP_VERSION) {
        url.searchParams.set('v', APP_VERSION);
        location.replace(url.toString());
      }
    })();


    /* ===== Îç∞Ïù¥ÌÑ∞ =====
       - addr ÏûàÏúºÎ©¥ ÏßÄÏò§ÏΩîÎî©, Ïã§Ìå®ÌïòÎ©¥ Ïù¥Î¶Ñ Í≤ÄÏÉâ Î≥¥ÏôÑ
       - urlÏùÄ "ÏûêÏÑ∏Ìïú Ï†ïÎ≥¥" Î≤ÑÌäºÏóêÏÑú ÏÉà ÌÉ≠ÏúºÎ°ú Ïò§Ìîà
       - timeÏùÄ Ï£ºÏÜå ÏïÑÎûò Ï§ÑÏóê ÌëúÏãú */
    const data = {
      day1: {
        places: [
          { id:1, name:'Î™ÖÌòÑÎßåÍ∞ÑÏû•Í≤åÏû• Ï≤úÏïàÏ†ê', category:'ÏùåÏãùÏ†ê', addr:'Ï∂©ÎÇ® Ï≤úÏïàÏãú ÏÑúÎ∂ÅÍµ¨ ÏõêÎëêÏ†ï8Í∏∏ 32', url:'https://naver.me/x2cE9jUN', time:'11:30 - 23:30' },
          { id:2, name:'Î≤†Ïä§ÌÇ®ÎùºÎπàÏä§ Ï≤úÏïàÎ®πÏûêÍ≥®Î™©Ï†ê', category:'ÎîîÏ†ÄÌä∏', addr:'Ï∂©ÎÇ® Ï≤úÏïàÏãú ÏÑúÎ∂ÅÍµ¨ ÎëêÏ†ïÎ°ú 168', url:'https://naver.me/GT6zzPIu', time:'10:00 - 23:00' },
          { id:3, name:'Ï†ïÎã¥Ï°±Î∞ú Ï≤úÏïàÎëêÏ†ïÏ†ê', category:'ÏùåÏãùÏ†ê', addr:'Ï∂©ÎÇ® Ï≤úÏïàÏãú ÏÑúÎ∂ÅÍµ¨ ÎëêÏ†ïÎ°ú 146', url:'https://naver.me/GzEcsTiy', time:'11:00 - 23:00 (14:00-15:00 Î∏åÎ†àÏù¥ÌÅ¨)' },
          { id:4, name:'Ïä§ÏúÑÌä∏Ïõê', category:'Ïò§ÎùΩÏã§', addr:'Ï∂©ÎÇ® Ï≤úÏïàÏãú ÏÑúÎ∂ÅÍµ¨ ÎëêÏ†ïÎèô 927', url:'https://naver.me/FK05VjaH', time:'24ÏãúÍ∞Ñ' },
          { id:5, name:'ÎåëÏä§PCÎ∞© Ï≤úÏïàÎëêÏ†ïÎ≥∏Ï†ê', category:'PCÎ∞©', addr:'Ï∂©ÎÇ® Ï≤úÏïàÏãú ÏÑúÎ∂ÅÍµ¨ ÎëêÏ†ïÎèô 886-1', url:'https://naver.me/xNnLjerb', time:'24ÏãúÍ∞Ñ' },
          { id:6, name:'Ï§ÄÏΩî Ï≤úÏïàÏÑ±Ï†ïÏ†ê', category:'ÏùåÏãùÏ†ê', addr:'Ï∂©ÎÇ® Ï≤úÏïàÏãú ÏÑúÎ∂ÅÍµ¨ ÏÑ±Ï†ïÎèô 1286', url:'https://naver.me/xhzb2jyd', time:'17:00 - 08:00' }
        ],
        todos:['Í≤åÏû•Ïóê ÏÜåÎß•','Î≤†ÎùºÏóêÏÑú Ìï¥Ïû•','Î∂àÏ°±Î∞úÏóê ÏÜåÏ£º','Ï¥àÏΩîÏóêÎ™Ω Î¨ºÍ≥† Ïù∏ÎΩë „Ñ±„Ñ±','ÌîºÏãúÎ∞©ÏóêÏÑú Ï†ïÏã† Ï∞®Î¶¨Î©¥ÏÑú ÎùºÎ©¥ Ìï¥Ïû•','Ï§ÄÏΩî „Ñ±„Ñ±','ÏßëÍ∞ÄÏÑú Í∏∞Ï†à „Ñ±„Ñ±']
      },
      day2: {
        places: [
          { id:1, name:'ÏΩ©Ïã¨ Ï≤úÏïàÎëêÏ†ïÏ†ê', category:'ÏùåÏãùÏ†ê', addr:'Ï∂©ÎÇ® Ï≤úÏïàÏãú ÏÑúÎ∂ÅÍµ¨ 1Í≥µÎã®1Í∏∏ 52', url:'https://naver.me/GTnhZfhG', time:'05:00 - 21:00' },
          { id:2, name:'Ïπ¥ÌéòÎã¥ÏÜå', category:'Ïπ¥Ìéò', addr:'Ï∂©ÎÇ® Ï≤úÏïàÏãú ÏÑúÎ∂ÅÍµ¨ ÎëêÏ†ïÎèô 1283', url:'https://naver.me/FN7XQXlD', time:'12:00-22:00' },
          { id:3, name:'Ï≤≠Ï∂òÍµ≠Î¨ºÎã≠Î∞ú ÎëêÏ†ïÏ†ê', category:'ÏùåÏãùÏ†ê', addr:'Ï∂©ÎÇ® Ï≤úÏïàÏãú ÏÑúÎ∂ÅÍµ¨ ÎëêÏ†ïÎèô 692', url:'https://naver.me/xf5MWI0i', time:'16:00 - 02:00' },
          { id:4, name:'Ïä§ÏúÑÌä∏Ïõê', category:'Ïò§ÎùΩÏã§', addr:'Ï∂©ÎÇ® Ï≤úÏïàÏãú ÏÑúÎ∂ÅÍµ¨ ÎëêÏ†ïÎèô 927', url:'https://naver.me/FK05VjaH', time:'24ÏãúÍ∞Ñ' },
          { id:5, name:'Ïö©Ïö©ÏÑ†ÏÉù Ï≤úÏïà ÎëêÏ†ïÏ†ê', category:'ÏùåÏãùÏ†ê', addr:'Ï∂©ÎÇ® Ï≤úÏïàÏãú ÏÑúÎ∂ÅÍµ¨ ÎëêÏ†ïÎèô 887', url:'https://naver.me/GDafeRVu', time:'16:00 - 04:00' },
          { id:6, name:'Ïä§Ìä∏ÎùºÏù¥ÌÅ¨Ï°¥ ÎëêÏ†ïÍµ¨Ïû•', category:'Î†àÏ†Ä', addr:'Ï∂©ÎÇ® Ï≤úÏïàÏãú ÏÑúÎ∂ÅÍµ¨ ÎëêÏ†ïÎèô 830', url:'https://naver.me/FfewTMo2', time:'15:00 - 01:00' },
          { id:7, name:'ÏÇºÏ∂òÎÑ§ Ïò•ÏÉÅÏßë', category:'ÏùåÏãùÏ†ê', addr:'Ï∂©ÎÇ® Ï≤úÏïàÏãú ÏÑúÎ∂ÅÍµ¨ ÎëêÏ†ïÎèô 843', url:'https://naver.me/5pwic6Y5', time:'17:00 - 02:00' }
        ],
        todos:['Íµ≠Î∞•Ïóê Ìï¥Ïû•Ïà†','Î∂ÑÏ°∞Ïπ¥ÏóêÏÑú ÏàòÎ∂Ñ Ï∂©Ï†Ñ','Îã≠Î∞úÏóê ÏÜåÏ£º','Ïò§ÎùΩÏã§ Ï∞¢Ïñ¥Î≤ÑÎ†§','Ïö©Ïö©ÏÑ†ÏÉùÏóê ÌååÍ¥¥Í¥ëÏÑ† ÏèòÍ∏∞','Ïä§ÏïºÍ∞ÄÏÑú Ïö∞Î¶¨Ïßë Í∞úÎπ†Îî∞Îì§Î≥¥Îã§ ÏïàÌÉÄ ÎßéÏù¥ÏπòÍ∏∞','Ìè¨Ïû•ÎßàÏ∞® ÎπÑÏä∑Ìïú Í∞¨ÏÑ± Ïà†Ïßë „Ñ±','ÏßëÍ∞ÄÏÑú ÏïºÍµ¨ ÏòÅÏÉÅ ÏãúÏ≤≠ÌïòÎ©∞ Îß•Ï£º']
      }
    };

    /* ===== Ï∂úÎ∞ú/ÎèÑÏ∞©(Í∞ôÏùÄ Ï£ºÏÜå) ===== */
    const HOME_ADDR = 'Ï∂©ÎÇ® Ï≤úÏïàÏãú ÏÑúÎ∂ÅÍµ¨ ÎëêÏ†ïÏó≠Îèô3Í∏∏ 49';

    /* ===== ÏÉÅÌÉú ===== */
    let map, markers=[], polyline=null;
    let startCoord=null, endCoord=null;
    let currentDay='day1', selectedPlaceId=null;
    const resolved = {};

    /* ===== Kakao SDK ÎèôÏ†Å Î°úÎìú ===== */
    async function bootKakao(cb){
      if (window.kakao?.maps?.load) return cb();
      const JS_KEY='b4355dd1e5b1ee165fcf0fa8371258c0';
      await new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src=`https://dapi.kakao.com/v2/maps/sdk.js?appkey=${JS_KEY}&libraries=services&autoload=false&ver=${APP_VERSION}`;
        s.async=true; s.defer=true;
        s.onload=resolve;
        s.onerror=()=>reject(new Error('Kakao SDK network error'));
        document.head.appendChild(s);
      }).catch(e=>{
        alert('Ïπ¥Ïπ¥Ïò§ ÏßÄÎèÑ SDK ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò: Í¥ëÍ≥†Ï∞®Îã®/Î∞©ÌôîÎ≤Ω/Îç∞Ïù¥ÌÑ∞ Ï∞®Îã® ÌôïÏù∏');
        throw e;
      });
    
      if (typeof window.kakao?.maps?.load === 'function') {
        window.kakao.maps.load(cb);
      } else {
        // üî¥ Ïó¨Í∏∞ÏÑú ÌòÑÏû¨ Ï†ëÏÜç ÎèÑÎ©îÏù∏ÏùÑ Î∞îÎ°ú Î≥¥Ïó¨Ï§òÏÑú ÏΩòÏÜîÏóê Ï∂îÍ∞ÄÌï† Ïàò ÏûàÍ≤å Ìï®
        alert(
          `Ïπ¥Ïπ¥Ïò§ ÏßÄÎèÑ SDK Î°úÎìú Ïã§Ìå® (ÎèÑÎ©îÏù∏ ÎØ∏Îì±Î°ù Í∞ÄÎä•ÏÑ±)\n\n` +
          `ÌòÑÏû¨ Ï†ëÏÜç ÎèÑÎ©îÏù∏:\n${location.origin}\n\n` +
          `Ïπ¥Ïπ¥Ïò§ Í∞úÎ∞úÏûê ÏΩòÏÜî > ÎÇ¥ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò > ÌîåÎû´Ìèº > Web > ÏÇ¨Ïù¥Ìä∏ ÎèÑÎ©îÏù∏Ïóê ÏúÑ Ï£ºÏÜå(Ìè¨Ìï® Ìè¨Ìä∏)Î•º Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.`
        );
        throw new Error('maps.load missing');
      }
    }


    /* ===== services helpers ===== */
    let placesService, geocoder;
    const hasCoord = p => p && typeof p.lat==='number' && typeof p.lng==='number';
    const toLatLng = o => new kakao.maps.LatLng(o.lat, o.lng);

    function geocodeAddress(address){
      return new Promise((resolve,reject)=>{
        geocoder.addressSearch(address,(result,status)=>{
          if(status===kakao.maps.services.Status.OK && result[0]){
            resolve({ lat:parseFloat(result[0].y), lng:parseFloat(result[0].x) });
          }else reject(new Error('geocode failed'));
        });
      });
    }

    async function searchPlaceByName(name, near){
      const tryKeyword=(q,opt)=>new Promise(res=>{
        placesService.keywordSearch(q,(r,st)=>{
          res(st===kakao.maps.services.Status.OK && r.length ? r[0] : null);
        },opt);
      });
      const baseOpt = near ? { location: toLatLng(near), radius: 7000 } : {};
      const rectOpt = (!near) ? {} : (()=> {
        const dx=0.03, dy=0.03;
        const rect=`${near.lng-dx},${near.lat-dy},${near.lng+dx},${near.lat+dy}`;
        return { rect };
      })();

      let hit = await tryKeyword(name, baseOpt);
      if(!hit) hit = await tryKeyword(`${name} Ï≤úÏïà`, baseOpt);
      if(!hit && near) hit = await tryKeyword(name, rectOpt);
      if(!hit) hit = await tryKeyword(`${name} ÎëêÏ†ï`, baseOpt);

      if(hit){
        return {
          lat: parseFloat(hit.y),
          lng: parseFloat(hit.x),
          address: hit.road_address_name || hit.address_name || '',
          kakaoName: hit.place_name
        };
      }
      console.warn('[keyword ZERO_RESULT]', name);
      return null;
    }

    async function resolveDayPlaces(day){
      if(resolved[day]) return resolved[day];
      const base = startCoord || {lat:36.8012, lng:127.1065};

      const results = await Promise.all(
        data[day].places.map(async pl=>{
          if (pl.addr && pl.addr.trim()){
            try{
              const c = await geocodeAddress(pl.addr.trim());
              return { ...pl, lat:c.lat, lng:c.lng, address:pl.addr };
            }catch{}
          }
          const hit = await searchPlaceByName(pl.name, base);
          return { ...pl, lat:hit?.lat ?? null, lng:hit?.lng ?? null, address:pl.addr || hit?.address || '' };
        })
      );

      resolved[day] = { places: results, todos: data[day].todos };
      return resolved[day];
    }

    /* ===== ÏßÄÎèÑ & ÎßàÏª§ ===== */
    function buildLabel(text){
      const el=document.createElement('div');
      el.className='map-marker-label';
      el.textContent=text;
      return el;
    }
    function addOverlay(coord,text,onClick){
      const content=buildLabel(text);
      if(onClick) content.addEventListener('click', onClick);
      const ov=new kakao.maps.CustomOverlay({ position: toLatLng(coord), content, yAnchor:1 });
      ov.setMap(map);
      return ov;
    }

    async function initMap(){
      const center = startCoord || {lat:36.831770, lng:127.136388};
      map = new kakao.maps.Map(document.getElementById('map'), { center: toLatLng(center), level: 6 });
      await updateMap();

      // ÏßÄÎèÑ Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞ Î≥ÄÌôî ÎåÄÏùë
      setTimeout(()=> map && map.relayout(), 0);
      window.addEventListener('resize', ()=> map && map.relayout());
      window.addEventListener('orientationchange', ()=> setTimeout(()=> map && map.relayout(), 300));
      
      // ÏßÄÏõêÎêòÎ©¥ ResizeObserverÎ°úÎèÑ Î≥¥Í∞ï
      const mapEl = document.getElementById('map');
      if ('ResizeObserver' in window && mapEl) {
        new ResizeObserver(()=> map && map.relayout()).observe(mapEl);
      }

    }

    async function updateMap(){
      markers.forEach(m=>m.setMap(null)); markers=[];
      if(polyline) polyline.setMap(null);

      const day = await resolveDayPlaces(currentDay);

      if(startCoord) markers.push(addOverlay(startCoord,'Ïßë'));
      if(endCoord)   markers.push(addOverlay(endCoord,'Ïßë'));

      day.places.forEach((pl,idx)=>{
        if(pl.lat && pl.lng){
          const coord={lat:pl.lat,lng:pl.lng};
          const ov=addOverlay(coord,String(idx+1),()=>highlightPlace(pl.id));
          markers.push(ov);
        }
      });

      const bounds=new kakao.maps.LatLngBounds();
      if(startCoord) bounds.extend(toLatLng(startCoord));
      day.places.forEach(pl=>{ if(pl.lat&&pl.lng) bounds.extend(new kakao.maps.LatLng(pl.lat,pl.lng)); });
      if(endCoord) bounds.extend(toLatLng(endCoord));
      if(!bounds.isEmpty()) map.setBounds(bounds,40,40,40,40);
    }

    /* ===== ÏÇ¨Ïù¥ÎìúÎ∞î ===== */
    const normalizeUrl = (u) => /^https?:\/\//i.test(u) ? u : ('https://' + u);

    // Ï£ºÏÜå/ÏòÅÏóÖÏãúÍ∞Ñ ÎùºÏù∏ Ï∂úÎ†•
    function metaHtml(addr, time){
      let html = '';
      if(addr) html += `<div class="place-addr"><small>${addr}</small></div>`;
      if(time) html += `<div class="place-time"><small>üïí ${time}</small></div>`;
      return html;
    }

    async function updatePlaceList(){
      const placeList=document.getElementById('placeList');
      const dayData = await resolveDayPlaces(currentDay);
      const places  = dayData.places;

      placeList.innerHTML = places.map((p,i)=>{
        const isFirst = i===0, isLast = i===places.length-1;
        const canPrevTo   = !isFirst && (p.lat!=null && p.lng!=null) && (places[i-1].lat!=null && places[i-1].lng!=null);
        const canStartTo1 =  isFirst && startCoord && (p.lat!=null && p.lng!=null);
        const canToEnd    =  isLast  && endCoord && (p.lat!=null && p.lng!=null);
        const hasUrl      =  !!(p.url && p.url.trim());

        return `
          <div class="place-item" data-place-id="${p.id}">
            <div class="place-header">
              <div class="place-number">${i+1}</div>
              <div class="place-info">
                <div class="place-name">${p.name}</div>
                <div class="place-category">${p.category}${(p.lat==null||p.lng==null)?` ¬∑ <small style="color:#e53935">Ï¢åÌëú ÎØ∏ÌôïÏ†ï</small>`:''}</div>
                <div class="place-meta">
                  ${metaHtml(p.address, p.time)}
                </div>
              </div>
            </div>
            <div class="direction-row" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
              <button class="btn info" data-kind="${isFirst?'info-start':'info-prev'}" data-idx="${i}" ${hasUrl?'':'disabled'}>ÏûêÏÑ∏Ìïú Ï†ïÎ≥¥</button>
              ${isFirst ? `
                <button class="btn walk" data-kind="walk-start" data-idx="${i}" ${canStartTo1?'':'disabled'}>Í∏∏Ï∞æÍ∏∞</button>
              ` : `
                <button class="btn walk" data-kind="walk-prev" data-idx="${i}" ${canPrevTo?'':'disabled'}>Í∏∏Ï∞æÍ∏∞</button>
              `}
              ${isLast ? `
                <button class="btn secondary walk" data-kind="walk-end" data-idx="${i}" ${canToEnd?'':'disabled'}>ÏßëÍ∞ÄÎäî Í∏∏</button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');

      // Ìï≠Î™© ÌÅ¥Î¶≠ Ïãú ÌïòÏù¥ÎùºÏù¥Ìä∏
      placeList.querySelectorAll('.place-item').forEach(item=>{
        item.addEventListener('click',e=>{
          if(e.target.classList.contains('btn')) return;
          highlightPlace(parseInt(item.dataset.placeId));
        });
      });

      // Î≤ÑÌäº ÎèôÏûë
      placeList.querySelectorAll('.btn').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          e.stopPropagation();
          const idx=parseInt(btn.dataset.idx);
          const kind=btn.dataset.kind;
          const arr=(await resolveDayPlaces(currentDay)).places;

          // Ï†ïÎ≥¥ Î≤ÑÌäº ‚Üí url Ïò§Ìîà
          if(kind==='info-start' || kind==='info-prev'){
            const target = (kind==='info-start') ? arr[0] : arr[idx];
            if(target?.url){
              window.open(normalizeUrl(target.url.trim()), '_blank', 'noopener');
            }else{
              alert('Ïù¥ Ïû•ÏÜåÏóêÎäî Îì±Î°ùÎêú ÎßÅÌÅ¨Í∞Ä ÏóÜÏñ¥Ïöî.');
            }
            return;
          }

          // Í∏∏Ï∞æÍ∏∞ Î≤ÑÌäºÎì§
          let from,to;
          if(kind==='walk-start'){ from={name:'Ï∂úÎ∞úÏßÄ',...startCoord}; to=arr[0]; }
          else if(kind==='walk-prev'){ from=arr[idx-1]; to=arr[idx]; }
          else if(kind==='walk-end'){ from=arr[idx]; to={name:'ÎèÑÏ∞©ÏßÄ',...endCoord}; }

          if(!from || !to || from.lat==null || to.lat==null) return alert('Ïù¥ Íµ¨Í∞ÑÏùÄ Ï¢åÌëúÍ∞Ä ÏóÜÏñ¥ ÏßÑÌñâÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
          openKakaoWalk(from,to);
        });
      });
    }

    function updateTodoList(){
      const todoList=document.getElementById('todoList');
      const todos=data[currentDay].todos;
      todoList.innerHTML=todos.map((t,i)=>`
        <div class="todo-item"><div class="todo-number">${i+1}.</div><div class="todo-text">${t}</div></div>
      `).join('');
    }

    function highlightPlace(placeId){
      selectedPlaceId=placeId;
      document.querySelectorAll('.place-item').forEach(it=>{
        it.classList.toggle('active', parseInt(it.dataset.placeId)===placeId);
      });
      const pl=resolved[currentDay]?.places.find(p=>p.id===placeId);
      if(pl?.lat && pl?.lng) map.setCenter(new kakao.maps.LatLng(pl.lat,pl.lng));
    }

    // Ïπ¥Ïπ¥Ïò§ Í≥µÏãù ÎßÅÌÅ¨: /link/by/walk/Ïù¥Î¶Ñ,ÏúÑÎèÑ,Í≤ΩÎèÑ/Ïù¥Î¶Ñ,ÏúÑÎèÑ,Í≤ΩÎèÑ
    function openKakaoWalk(fromPlace,toPlace){
      const enc = (s)=>encodeURIComponent(String(s));
      const lat = (n)=>Number(n).toFixed(7);
      const seg = (p)=>`${enc(p.name||'ÏßÄÏ†ê')},${lat(p.lat)},${lat(p.lng)}`;
      const url = `https://map.kakao.com/link/by/walk/${seg(fromPlace)}/${seg(toPlace)}`;
      window.open(url, '_blank', 'noopener');
    }

    /* ===== Day Ïä§ÏúÑÏπò ===== */
    document.querySelectorAll('.day-btn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        document.querySelectorAll('.day-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        currentDay=btn.dataset.day;
        selectedPlaceId=null;
        await updateMap();
        await updatePlaceList();
        updateTodoList();
      });
    });

    /* ===== Ï¥àÍ∏∞ Ïã§Ìñâ ===== */
    window.addEventListener('DOMContentLoaded', ()=>{
      bootKakao(async ()=>{
        placesService=new kakao.maps.services.Places();
        geocoder=new kakao.maps.services.Geocoder();

        try{
          startCoord = await geocodeAddress(HOME_ADDR);
          endCoord   = { ...startCoord };
        }catch{
          startCoord = {lat:36.8012, lng:127.1065};
          endCoord   = { ...startCoord };
        }

        await resolveDayPlaces(currentDay);
        await initMap();
        await updatePlaceList();
        updateTodoList();
      });
    });
  </script>
</body>
</html>
