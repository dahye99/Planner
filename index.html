<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ïà†ÏùÑ Î®πÏûê ÎÉ†ÎÉêÎØ∏</title>
  <link rel="icon" href="data:,">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f5f5f5; }
    .container { display:flex; height:100vh; flex-direction:column; }
    .day-selector { display:flex; gap:20px; padding:20px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.1); justify-content:center; }
    .day-btn { padding:12px 30px; border:2px solid #ddd; border-radius:25px; background:#fff; cursor:pointer; font-size:16px; font-weight:600; transition:.3s; }
    .day-btn.active { background:#2196F3; color:#fff; border-color:#2196F3; }
    .day-btn:hover { border-color:#2196F3; }
    .content { display:flex; flex:1; gap:20px; padding:20px; overflow:hidden; }
    .map-container { flex:1; border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,.1); position:relative; }
    #map { width:100%; height:100%; }
    .map-marker-label {
      background:#fff; padding:8px 12px; border-radius:20px; border:2px solid #2196F3;
      font-weight:bold; font-size:14px; color:#2196F3; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.15); transition:.2s;
    }
    .map-marker-label:hover { background:#2196F3; color:#fff; transform:scale(1.1); }
    .sidebar { width:350px; display:flex; flex-direction:column; gap:20px; overflow-y:auto; }
    .list-section { background:#fff; border-radius:12px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,.1); flex:1; overflow-y:auto; }
    .list-section h2 { font-size:18px; margin-bottom:15px; color:#333; border-bottom:2px solid #f0f0f0; padding-bottom:10px; }
    .place-item { display:flex; flex-direction:column; gap:8px; padding:12px; margin-bottom:10px; background:#f9f9f9; border-radius:8px; cursor:pointer; transition:.3s; border-left:4px solid #e0e0e0; }
    .place-item:hover { background:#e3f2fd; border-left-color:#2196F3; transform:translateX(5px); }
    .place-header { display:flex; align-items:center; gap:12px; }
    .place-number { display:flex; align-items:center; justify-content:center; width:32px; height:32px; background:#2196F3; color:#fff; border-radius:50%; font-weight:bold; font-size:14px; flex-shrink:0; }
    .place-info { flex:1; min-width:0; }
    .place-name { font-weight:600; color:#333; margin-bottom:4px; word-break:break-word; }
    .place-category { font-size:12px; color:#999; }
    .place-item.active { background:#fff3e0; border-left-color:#ff9800; }
    .direction-btn { padding:8px 12px; background:#4CAF50; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600; transition:.2s; }
    .direction-btn:hover { background:#45a049; transform:scale(1.05); }
    .direction-btn.secondary { background:#9c27b0; }
    .direction-btn.secondary:hover { background:#7b1fa2; }
    .direction-btn:disabled { background:#ccc; cursor:not-allowed; transform:none; }
    .todo-item { display:flex; align-items:flex-start; gap:10px; padding:12px; margin-bottom:8px; background:#f9f9f9; border-radius:8px; border-left:4px solid #4CAF50; word-break:break-word; }
    .todo-number { font-weight:bold; color:#4CAF50; flex-shrink:0; min-width:20px; }
    .todo-text { color:#333; font-size:14px; }
    .sidebar::-webkit-scrollbar, .list-section::-webkit-scrollbar { width:6px; }
    .sidebar::-webkit-scrollbar-track, .list-section::-webkit-scrollbar-track { background:#f1f1f1; border-radius:10px; }
    .sidebar::-webkit-scrollbar-thumb, .list-section::-webkit-scrollbar-thumb { background:#888; border-radius:10px; }
    .sidebar::-webkit-scrollbar-thumb:hover, .list-section::-webkit-scrollbar-thumb:hover { background:#555; }
    @media (max-width:1024px) {
      .content { flex-direction:column; }
      .sidebar { width:100%; height:40%; }
      .map-container { height:60%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="day-selector">
      <button class="day-btn active" data-day="day1">Day 1</button>
      <button class="day-btn" data-day="day2">Day 2</button>
    </div>

    <div class="content">
      <div class="map-container"><div id="map"></div></div>
      <div class="sidebar">
        <div class="list-section">
          <h2>üóíÔ∏è Place List</h2>
          <div id="placeList"></div>
        </div>
        <div class="list-section">
          <h2>üóíÔ∏è To-do List</h2>
          <div id="todoList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***** 1) ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞: Ïù¥Î¶Ñ/Ïπ¥ÌÖåÍ≥†Î¶¨Îßå ÏÇ¨Ïö© *****/
    const data = {
      day1: {
        places: [
          { id: 1, name: 'Î™ÖÌòÑÎßåÍ∞ÑÏû•Í≤åÏû• Ï≤úÏïàÏ†ê', category: 'ÏùåÏãùÏ†ê' },
          { id: 2, name: 'Î≤†Ïä§ÌÇ®ÎùºÎπàÏä§ Ï≤úÏïàÎ®πÏûêÍ≥®Î™©Ï†ê', category: 'ÎîîÏ†ÄÌä∏' },
          { id: 3, name: 'Ï†ïÎã¥Ï°±Î∞ú Ï≤úÏïàÎëêÏ†ïÏ†ê', category: 'ÏùåÏãùÏ†ê' },
          { id: 4, name: 'Ïä§ÏúÑÌä∏Ïõê', category: 'Ïò§ÎùΩÏã§' },
          { id: 5, name: 'ÎåëÏä§PCÎ∞© Ï≤úÏïàÎëêÏ†ïÎ≥∏Ï†ê', category: 'PCÎ∞©' },
          { id: 6, name: 'Ï§ÄÏΩî Ï≤úÏïàÏÑ±Ï†ïÏ†ê', category: 'ÏùåÏãùÏ†ê' }
        ],
        todos: [
          'Í≤åÏû•Ïóê ÏÜåÎß•','Î≤†ÎùºÏóêÏÑú Ìï¥Ïû•','Î∂àÏ°±Î∞úÏóê ÏÜåÏ£º','Ï¥àÏΩîÏóêÎ™Ω Î¨ºÍ≥† Ïù∏ÎΩë „Ñ±„Ñ±','ÌîºÏãúÎ∞©ÏóêÏÑú Ï†ïÏã† Ï∞®Î¶¨Î©¥ÏÑú ÎùºÎ©¥ Ìï¥Ïû•','Ï§ÄÏΩî „Ñ±„Ñ±','ÏßëÍ∞ÄÏÑú Í∏∞Ï†à „Ñ±„Ñ±'
        ]
      },
      day2: {
        places: [
          { id: 1, name: 'ÏΩ©Ïã¨ Ï≤úÏïàÎëêÏ†ïÏ†ê', category: 'ÏùåÏãùÏ†ê' },
          { id: 2, name: 'Î°úÎß®Ìã±ÌåîÎ†àÌä∏Ïπ¥Ìéò ÎëêÏ†ïÏ†ê', category: 'Ïπ¥Ìéò' },
          { id: 3, name: 'Ï≤≠Ï∂òÍµ≠Î¨ºÎã≠Î∞ú ÎëêÏ†ïÏ†ê', category: 'ÏùåÏãùÏ†ê' },
          { id: 4, name: 'Ïä§ÏúÑÌä∏Ïõê', category: 'Ïò§ÎùΩÏã§' },
          { id: 5, name: 'Ïö©Ïö©ÏÑ†ÏÉù Ï≤úÏïà ÎëêÏ†ïÏ†ê', category: 'ÏùåÏãùÏ†ê' },
          { id: 6, name: 'Ïä§Ìä∏ÎùºÏù¥ÌÅ¨Ï°¥ ÎëêÏ†ïÍµ¨Ïû•', category: 'Î†àÏ†Ä' },
          { id: 7, name: 'ÏÇºÏ∂òÎÑ§ Ïò•ÏÉÅÏßë', category: 'ÏùåÏãùÏ†ê' }
        ],
        todos: [
          'Íµ≠Î∞•Ïóê Ìï¥Ïû•Ïà†','Î∂ÑÏ°∞Ïπ¥ÏóêÏÑú ÏàòÎ∂Ñ Ï∂©Ï†Ñ','Îã≠Î∞úÏóê ÏÜåÏ£º','Ïò§ÎùΩÏã§ Ï∞¢Ïñ¥Î≤ÑÎ†§','Ïö©Ïö©ÏÑ†ÏÉùÏóê ÌååÍ¥¥Í¥ëÏÑ† ÏèòÍ∏∞','Ïä§ÏïºÍ∞ÄÏÑú Ïö∞Î¶¨Ïßë Í∞úÎπ†Îî∞Îì§Î≥¥Îã§ ÏïàÌÉÄ ÎßéÏù¥ÏπòÍ∏∞','Ìè¨Ïû•ÎßàÏ∞® ÎπÑÏä∑Ìïú Í∞¨ÏÑ± Ïà†Ïßë „Ñ±','ÏßëÍ∞ÄÏÑú ÏïºÍµ¨ ÏòÅÏÉÅ ÏãúÏ≤≠ÌïòÎ©∞ Îß•Ï£º'
        ]
      }
    };

    /***** 2) ÏÉÅÏàò: Ï∂úÎ∞ú/ÎèÑÏ∞© Ï£ºÏÜå *****/
    const HOME_ADDR = 'Ï∂©ÎÇ® Ï≤úÏïàÏãú ÏÑúÎ∂ÅÍµ¨ ÎëêÏ†ïÏó≠Îèô3Í∏∏ 49';

    /***** 3) ÏÉÅÌÉú *****/
    let map, markers = [], polyline = null;
    let startCoord = null, endCoord = null; // {lat, lng}
    let currentDay = 'day1', selectedPlaceId = null;

    const resolved = { }; // dayÎ≥ÑÎ°ú Í≤ÄÏÉâÌï¥ ÏñªÏùÄ Ï¢åÌëú Ï∫êÏãú

    /***** 4) Kakao SDK ÎèôÏ†Å Î°úÎçî *****/
    async function bootKakao(callback) {
      if (window.kakao?.maps?.load) return callback();
      const JS_KEY = 'b4355dd1e5b1ee165fcf0fa8371258c0';
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${JS_KEY}&libraries=services&autoload=false&ver=${Date.now()}`;
        s.async = true; s.defer = true;
        s.onload = resolve;
        s.onerror = e => reject(new Error('Kakao SDK network error'));
        document.head.appendChild(s);
      }).catch(e => { alert('Ïπ¥Ïπ¥Ïò§ ÏßÄÎèÑ SDK ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò: Í¥ëÍ≥†Ï∞®Îã®/Î∞©ÌôîÎ≤Ω/ÎèÑÎ©îÏù∏ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.'); throw e; });
      if (typeof window.kakao?.maps?.load === 'function') window.kakao.maps.load(callback);
      else { alert('Ïπ¥Ïπ¥Ïò§ ÏßÄÎèÑ SDK Î°úÎìú Ïã§Ìå®: ÎèÑÎ©îÏù∏/JavaScript ÌÇ§ ÌôïÏù∏'); throw new Error('maps.load missing'); }
    }

    /***** 5) Kakao services helpers *****/
    let placesService, geocoder;
    function toLatLng(obj) { return new kakao.maps.LatLng(obj.lat, obj.lng); }

    function geocodeAddress(address) {
      return new Promise((resolve, reject) => {
        geocoder.addressSearch(address, (result, status) => {
          if (status === kakao.maps.services.Status.OK && result[0]) {
            resolve({ lat: parseFloat(result[0].y), lng: parseFloat(result[0].x) });
          } else reject(new Error('geocode failed'));
        });
      });
    }

    // Îçî Í≤¨Í≥†Ìïú Ïû•ÏÜåÎ™Ö Í≤ÄÏÉâ: Îã§Ï§ë ÏãúÎèÑ + ÏßÄÏó≠ ÌûåÌä∏ + ÏÇ¨Í∞ÅÌòï Ï†úÌïú
    async function searchPlaceByName(name, near) {
      const tryKeyword = (q, opt) => new Promise((resolve) => {
        placesService.keywordSearch(q, (res, status) => {
          if (status === kakao.maps.services.Status.OK && res.length) resolve(res[0]);
          else resolve(null);
        }, opt);
      });
    
      // Í∏∞Ï§ÄÏ†êÏù¥ ÏûàÏúºÎ©¥ Î∞òÍ≤Ω/ÏÇ¨Í∞ÅÌòï ÏòµÏÖò Íµ¨ÏÑ±
      const RADIUS_M = 7000; // 7km
      const baseOpt = near ? { location: toLatLng(near), radius: RADIUS_M } : {};
      const rectOpt = (() => {
        if (!near) return {};
        // ÎåÄÎûµ 0.03ÎèÑ ‚âí 3km Í∑ºÏ≤ò (ÏúÑÍ≤ΩÎèÑ ÎåÄÎûµÏπò) ‚Äî ÏÇ¨Í∞ÅÌòï Ï†úÌïú
        const dx = 0.03, dy = 0.03;
        const rect = `${near.lng - dx},${near.lat - dy},${near.lng + dx},${near.lat + dy}`;
        return { rect };
      })();
    
      // 1) ÏõêÎ¨∏ Í≤ÄÏÉâ
      let hit = await tryKeyword(name, baseOpt);
      // 2) ÏßÄÏó≠ ÌûåÌä∏(Ï≤úÏïà) Ï∂îÍ∞Ä
      if (!hit) hit = await tryKeyword(`${name} Ï≤úÏïà`, baseOpt);
      // 3) ÏÇ¨Í∞ÅÌòï(rect)Î°ú Í∞ïÏ†ú ÏßÄÏó≠ Ï†úÌïú
      if (!hit && near) hit = await tryKeyword(name, rectOpt);
      // 4) ÎèôÎÑ§ ÌûåÌä∏(ÎëêÏ†ï) Ï∂îÍ∞Ä
      if (!hit) hit = await tryKeyword(`${name} ÎëêÏ†ï`, baseOpt);
    
      if (hit) {
        const p = hit;
        return {
          lat: parseFloat(p.y),
          lng: parseFloat(p.x),
          address: p.road_address_name || p.address_name || '',
          kakaoName: p.place_name
        };
      }
    
      // ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏(Í∞úÎ∞úÏö©)
      console.warn('[keyword ZERO_RESULT]', name);
      return null;
    }


    async function resolveDayPlaces(day) {
      if (resolved[day]) return resolved[day]; // Ï∫êÏãú
      const base = startCoord || { lat: 36.8012, lng: 127.1065 };
      const places = data[day].places;

      const results = await Promise.all(places.map(async (pl) => {
        const hit = await searchPlaceByName(pl.name, base);
        return { ...pl, lat: hit?.lat ?? null, lng: hit?.lng ?? null, address: hit?.address ?? '' };
      }));

      resolved[day] = { places: results, todos: data[day].todos };
      return resolved[day];
    }

    /***** 6) ÏßÄÎèÑ *****/
    function buildLabel(text) {
      const el = document.createElement('div');
      el.className = 'map-marker-label';
      el.textContent = text;
      return el;
    }

    function addOverlay(coord, text, onClick) {
      const content = buildLabel(text);
      if (onClick) content.addEventListener('click', onClick);
      const ov = new kakao.maps.CustomOverlay({ position: toLatLng(coord), content, yAnchor: 1 });
      ov.setMap(map);
      return ov;
    }

    async function initMap() {
      const mapContainer = document.getElementById('map');
      const center = startCoord || { lat: 36.831770, lng: 127.136388 };
      map = new kakao.maps.Map(mapContainer, { center: toLatLng(center), level: 6 });
      await updateMap(); // ÏµúÏ¥à Î†åÎçî
    }

    async function updateMap() {
      // Ïò§Î≤ÑÎ†àÏù¥ Ï¥àÍ∏∞Ìôî
      markers.forEach(m => m.setMap(null));
      markers = [];
      if (polyline) polyline.setMap(null);

      // ÌòÑÏû¨ ÏùºÏûêÏùò Ï¢åÌëú Î≥¥Ï†ï Í≤∞Í≥º ÌôïÎ≥¥
      const day = await resolveDayPlaces(currentDay);

      // S(Ï∂úÎ∞ú) / E(ÎèÑÏ∞©) Ïò§Î≤ÑÎ†àÏù¥
      if (startCoord) markers.push(addOverlay(startCoord, 'S'));
      if (endCoord)   markers.push(addOverlay(endCoord,   'E'));

      // Ïû•ÏÜåÎì§ Ïò§Î≤ÑÎ†àÏù¥ (1..N)
      day.places.forEach((pl, idx) => {
        if (pl.lat && pl.lng) {
          const coord = { lat: pl.lat, lng: pl.lng };
          const ov = addOverlay(coord, String(idx + 1), () => highlightPlace(pl.id));
          markers.push(ov);
        }
      });

      // ÏßÄÎèÑ bounds ÎßûÏ∂îÍ∏∞ (S, Î™®Îì† place, E)
      const bounds = new kakao.maps.LatLngBounds();
      if (startCoord) bounds.extend(toLatLng(startCoord));
      day.places.forEach(pl => { if (pl.lat && pl.lng) bounds.extend(new kakao.maps.LatLng(pl.lat, pl.lng)); });
      if (endCoord) bounds.extend(toLatLng(endCoord));
      if (!bounds.isEmpty()) map.setBounds(bounds, 40, 40, 40, 40); // padding
    }

    /***** 7) ÏÇ¨Ïù¥ÎìúÎ∞î *****/
    async function updatePlaceList() {
      const placeList = document.getElementById('placeList');
      const day = await resolveDayPlaces(currentDay);
      const places = day.places;

      placeList.innerHTML = places.map((place, index) => `
        <div class="place-item" data-place-id="${place.id}">
          <div class="place-header">
            <div class="place-number">${index + 1}</div>
            <div class="place-info">
              <div class="place-name">${place.name}</div>
              <div class="place-category">${place.category}${place.address ? ` ¬∑ <small>${place.address}</small>` : ''}</div>
            </div>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="direction-btn" data-kind="${index === 0 ? 'start-to' : 'prev-to'}" data-idx="${index}">
              ${index === 0 ? 'S ‚Üí 1 Í∏∏Ï∞æÍ∏∞' : '‚Üê Í∏∏Ï∞æÍ∏∞'}
            </button>
            ${index === places.length - 1 ? `<button class="direction-btn secondary" data-kind="to-end" data-idx="${index}">N ‚Üí E Í∏∏Ï∞æÍ∏∞</button>` : ''}
          </div>
        </div>
      `).join('');

      // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
      placeList.querySelectorAll('.place-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.classList.contains('direction-btn')) return;
          highlightPlace(parseInt(item.dataset.placeId));
        });
      });

      placeList.querySelectorAll('.direction-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const idx = parseInt(btn.dataset.idx);
          const kind = btn.dataset.kind;

          const dayData = await resolveDayPlaces(currentDay);
          const arr = dayData.places;

          let from, to;
          if (kind === 'start-to') {
            from = { name: 'Ï∂úÎ∞úÏßÄ', lat: startCoord.lat, lng: startCoord.lng };
            to   = arr[idx];
          } else if (kind === 'prev-to') {
            from = arr[idx - 1];
            to   = arr[idx];
          } else if (kind === 'to-end') {
            from = arr[idx];
            to   = { name: 'ÎèÑÏ∞©ÏßÄ', lat: endCoord.lat, lng: endCoord.lng };
          }
          if (from && to && from.lat && to.lat) showDirection(from, to);
          else alert('Ï¢åÌëúÍ∞Ä ÏóÜÎäî Ìï≠Î™©Ïù¥ ÏûàÏñ¥ Í∏∏Ï∞æÍ∏∞Î•º ÌëúÏãúÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
        });
      });
    }

    function updateTodoList() {
      const todoList = document.getElementById('todoList');
      const todos = data[currentDay].todos;
      todoList.innerHTML = todos.map((todo, i) => `
        <div class="todo-item"><div class="todo-number">${i+1}.</div><div class="todo-text">${todo}</div></div>
      `).join('');
    }

    function highlightPlace(placeId) {
      selectedPlaceId = placeId;
      document.querySelectorAll('.place-item').forEach(item => {
        item.classList.remove('active');
        if (parseInt(item.dataset.placeId) === placeId) item.classList.add('active');
      });
      const pl = resolved[currentDay]?.places.find(p => p.id === placeId);
      if (pl?.lat && pl?.lng) map.setCenter(new kakao.maps.LatLng(pl.lat, pl.lng));
    }

    function showDirection(fromPlace, toPlace) {
      if (polyline) polyline.setMap(null);
      const p1 = new kakao.maps.LatLng(fromPlace.lat, fromPlace.lng);
      const p2 = new kakao.maps.LatLng(toPlace.lat, toPlace.lng);
      polyline = new kakao.maps.Polyline({
        path: [p1, p2], strokeWeight:3, strokeColor:'#2196F3', strokeOpacity:0.7, strokeStyle:'dash'
      });
      polyline.setMap(map);
      const dist = kakao.maps.util.getDistance(p1, p2);
      alert(`${fromPlace.name} ‚Üí ${toPlace.name}\nÍ±∞Î¶¨: ${(dist/1000).toFixed(2)}km`);
    }

    /***** 8) Ïù¥Î≤§Ìä∏ *****/
    document.querySelectorAll('.day-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentDay = btn.dataset.day;
        selectedPlaceId = null;
        await updateMap();
        await updatePlaceList();
        updateTodoList();
      });
    });

    /***** 9) Ï¥àÍ∏∞ Ïã§Ìñâ *****/
    window.addEventListener('DOMContentLoaded', () => {
      bootKakao(async () => {
        placesService = new kakao.maps.services.Places();
        geocoder = new kakao.maps.services.Geocoder();

        // Ï∂úÎ∞ú/ÎèÑÏ∞©ÏßÄ Ï¢åÌëú Í≥ÑÏÇ∞ (ÎèôÏùº Ï£ºÏÜå)
        try {
          startCoord = await geocodeAddress(HOME_ADDR);
          endCoord = { ...startCoord };
        } catch {
          // Ïã§Ìå®Ïãú Í∏∞Î≥∏Í∞í(Ï≤úÏïà ÎëêÏ†ïÏó≠ Í∑ºÏ≤ò)
          startCoord = { lat: 36.8012, lng: 127.1065 };
          endCoord   = { ...startCoord };
        }

        await resolveDayPlaces(currentDay);
        await initMap();
        await updatePlaceList();
        updateTodoList();
      });
    });
  </script>
</body>
</html>
